#!/bin/execlineb -S0

# clean up tempdirs; this is safe even if they're mounted as tmpfs
if { find /run /tmp -mindepth 1 -delete }
if { cp -as /etc/s6-init/run / }

# save the environment before we clean it up in case any children want it
background { s6-dumpenv /run/env }
env -i PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

# dup stderr (i.e. emergency log) to fd0, for uncaught-logs to fetch
fdmove -c 0 2

# otherwise, set up the root of the logging chain and boot into s6-svscan
define fifo /run/s6/uncaught-logs/in

if { mkfifo -m 0600 $fifo }
if { chown root:daemon /var/log }
if { chmod 3775 /var/log }

# fifo trickery allows log collector to start up before unblocking stage2
background {
  redirfd -r 0 $fifo redirfd -r 0 /dev/null
  redirfd -w 2 $fifo fdmove -c 1 2
  /etc/s6-init/stage2
}

redirfd -w 2 $fifo fdmove -c 1 2
emptyenv -p s6-svscan -St0 /run/s6
